<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrandOrb | Intelligence Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navy: #0f172a; --blue: #38bdf8; --grey: #64748b; --bg: #f8fafc; --border: #e2e8f0; --white: #ffffff; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100vw; font-family: 'Inter', sans-serif; background: var(--navy); overflow: hidden; }
        #app-container { display: none; width: 100vw; height: 100vh; background: var(--bg); display: flex; }
        #sidebar { width: 280px; background: var(--navy); color: white; flex-shrink: 0; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.1); }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; width: calc(100vw - 280px); }
        header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); z-index: 10; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        h1 { margin: 0; font-size: 20px; font-weight: 700; color: var(--navy); }
        .nav-item { padding: 18px 25px; cursor: pointer; color: #94a3b8; font-weight: 700; text-transform: uppercase; font-size: 12px; display: flex; align-items: center; gap: 12px; }
        .nav-item.active { color: var(--blue); background: rgba(56, 189, 248, 0.1); }
        .btn-p { background: var(--navy); color: var(--blue); border: 1px solid var(--blue); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px; font-size: 13px; transition: 0.2s; }
        .btn-p:hover { background: #1e293b; color: white; }
        .input-s { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; outline: none; font-size: 13px; min-width: 150px; }
        .card { margin: 20px; background: white; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.02); overflow: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 12px 20px; text-align: left; font-size: 11px; text-transform: uppercase; color: var(--grey); border-bottom: 1px solid var(--border); }
        td { padding: 14px 20px; border-bottom: 1px solid var(--border); font-size: 13px; }
        #viz-container { display: none; flex-direction: column; height: 100%; position: relative; }
        #map-frame { flex-grow: 1; background: #0f172a; position: relative; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .modal-c { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        #login-scr { position: fixed; inset: 0; background: var(--navy); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 340px; text-align: center; }
    </style>
</head>
<body>
    <div id="login-scr">
        <div class="login-box">
            <h2>BrandOrb</h2>
            <input type="password" id="pass" class="input-s" placeholder="Access Key" style="width:100%; margin-bottom:15px; box-sizing:border-box;">
            <button class="btn-p" onclick="doLogin()" style="width:100%; justify-content:center;">Enter Dashboard</button>
            <button class="btn-p" onclick="changePass()"><i class="fas fa-key"></i> Change Key</button>
        </div>
    </div>

    <div id="app-container">
        <aside id="sidebar">
            <div style="padding:40px 20px; text-align:center;">
                <div style="background:white; padding:10px; border-radius:8px; display:inline-block;">
                    <span style="color:var(--navy); font-weight:800; font-size:22px;">BrandOrb</span>
                </div>
            </div>
            <div class="nav-item active" id="n-MAP" onclick="setTab('MAP')"><i class="fas fa-route"></i> <b>Route Reports</b></div>
            <div class="nav-item" id="n-CLUSTER" onclick="setTab('CLUSTER')"><i class="fas fa-project-diagram"></i> <b>Cluster Graphs</b></div>
        </aside>

        <main id="main-content">
            <header id="list-header">
                <div><h1>Intelligence Reports</h1></div>
                <div class="header-actions">
                    <input type="text" id="find-rep" class="input-s" placeholder="Search reports..." onkeyup="drawTable()">
                    <select id="cli-filter" class="input-s" onchange="drawTable()"></select>
                    <button class="btn-p" onclick="openClientMod()"><i class="fas fa-user-plus"></i> Add Client</button>
                    <button class="btn-p" onclick="openMod()"><i class="fas fa-plus"></i> Add Report</button>
                </div>
            </header>

    <script src="https://elfalem.github.io/Leaflet.curve/src/leaflet.curve.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<header id="viz-header-ui" style="display:none">
    <div style="display:flex; align-items:center; gap:15px;">
        <button class="btn-p" onclick="closeViz()"><i class="fas fa-arrow-left"></i> Back</button>
        <h1 id="v-title">Report</h1>
    </div>
    <div class="header-actions">
        <input type="text" id="ent-search" class="input-s" placeholder="Search Product/Entity..." onkeyup="window.recomputeViz()">
        <select id="entity-type-filter" class="input-s" onchange="window.recomputeViz()">
            <option value="All">All Entities</option>
            <option value="Exporter">Exporters Only</option>
            <option value="Importer">Importers Only</option>
        </select>
        <select id="orig-filter" class="input-s" onchange="window.recomputeViz()"></select>
        <select id="dest-filter" class="input-s" onchange="window.recomputeViz()"></select>
        <button class="btn-p" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i> Download PDF</button>
        <button class="btn-p" onclick="resetFilters()"><i class="fas fa-sync"></i> Reset</button>
    </div>
</header>

            <div id="list-view" class="card">
                <table>
                    <thead><tr><th>Name</th><th>Client</th><th>Type</th><th style="text-align:right">Action</th></tr></thead>
                    <tbody id="rep-rows"></tbody>
                </table>
            </div>

            <div id="viz-container">
                <div id="map-frame"></div>
            </div>
        </main>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-c">
            <h3>New Intelligence Report</h3>
            <input type="text" id="m-title" class="input-s" placeholder="Report Title" style="width:100%; margin-bottom:10px; box-sizing:border-box;">
            <input type="text" id="m-url" class="input-s" placeholder="Google Sheet URL" style="width:100%; margin-bottom:10px; box-sizing:border-box;">
            <select id="m-client" class="input-s" style="width:100%; margin-bottom:10px;"></select>
            <select id="m-type" class="input-s" style="width:100%; margin-bottom:20px;">
                <option value="MAP">Route Map</option>
                <option value="CLUSTER">Cluster Graph</option>
            </select>
            <div style="display:flex; gap:10px;">
                <button class="btn-p" onclick="publishReport()" style="flex:1; justify-content:center;">Publish</button>
                <button onclick="closeMod()" style="flex:1; border:none; background:none; cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="client-modal" class="modal">
        <div class="modal-c">
            <h3>Add New Client</h3>
            <input type="text" id="new-client-name" class="input-s" placeholder="Client Name" style="width:100%; margin-bottom:20px; box-sizing:border-box;">
            <div style="display:flex; gap:10px;">
                <button class="btn-p" onclick="saveClient()" style="flex:1; justify-content:center;">Add Client</button>
                <button onclick="closeClientMod()" style="flex:1; border:none; background:none; cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="visuals.js"></script>

    <script>
        const KEY = "admin123";
        // PERSISTENCE: Load from LocalStorage
        let reports = JSON.parse(localStorage.getItem('bo_reports')) || [];
        let clients = JSON.parse(localStorage.getItem('bo_clients')) || ["General", "TRX"];
        let tab = 'MAP', LMap = null, rawData = [];

        // Initialize or fetch the password
let currentKey = localStorage.getItem('bo_key') || "admin123";

function doLogin() {
    const input = document.getElementById('pass').value;
    if(input === currentKey) {
        document.getElementById('login-scr').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        updateClientDropdowns();
        drawTable();
    } else {
        alert("Invalid Key");
    }
}

function changePass() {
    const old = prompt("Enter current Access Key:");
    if(old === currentKey) {
        const newK = prompt("Enter NEW Access Key:");
        if(newK && newK.length > 3) {
            currentKey = newK;
            localStorage.setItem('bo_key', newK);
            alert("Key updated successfully!");
        } else {
            alert("Key too short!");
        }
    } else {
        alert("Incorrect current key.");
    }
}


        function updateClientDropdowns() {
            const options = clients.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('cli-filter').innerHTML = `<option value="All">All Clients</option>` + options;
            document.getElementById('m-client').innerHTML = options;
            localStorage.setItem('bo_clients', JSON.stringify(clients));
        }

        function saveClient() {
            const name = document.getElementById('new-client-name').value;
            if(name) {
                clients.push(name);
                updateClientDropdowns();
                closeClientMod();
            }
        }

        function publishReport() {
            const title = document.getElementById('m-title').value;
            const url = document.getElementById('m-url').value;
            const client = document.getElementById('m-client').value;
            const type = document.getElementById('m-type').value;

            if(title && url) {
                reports.push({ id: Date.now(), name: title, url: url, type: type, client: client });
                localStorage.setItem('bo_reports', JSON.stringify(reports));
                drawTable();
                closeMod();
                document.getElementById('m-title').value = "";
                document.getElementById('m-url').value = "";
            } else alert("Please fill Title and URL");
        }

        function deleteReport(id) {
            if(confirm("Delete this report?")) {
                reports = reports.filter(r => r.id !== id);
                localStorage.setItem('bo_reports', JSON.stringify(reports));
                drawTable();
            }
        }

        function drawTable() {
            const search = document.getElementById('find-rep').value.toLowerCase();
            const clientFilter = document.getElementById('cli-filter').value;
            const tbody = document.getElementById('rep-rows');
            const filtered = reports.filter(r => r.type === tab && r.name.toLowerCase().includes(search) && (clientFilter === "All" || r.client === clientFilter));
            
            tbody.innerHTML = filtered.length ? filtered.map(r => `
                <tr><td><b>${r.name}</b></td><td>${r.client}</td><td>${r.type}</td>
                <td style="text-align:right">
                    <button class="btn-p" style="display:inline-flex" onclick="initViz('${r.url}', '${r.name}')">View</button>
                    <button class="btn-p" style="display:inline-flex; border-color:#f43f5e; color:#f43f5e;" onclick="deleteReport(${r.id})"><i class="fas fa-trash"></i></button>
                </td></tr>`).join('') : `<tr><td colspan="4" style="text-align:center; padding:20px;">No reports found.</td></tr>`;
        }

        async function initViz(url, title) {
            document.getElementById('list-header').style.display = 'none';
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('viz-header-ui').style.display = 'flex';
            document.getElementById('viz-container').style.display = 'flex';
            document.getElementById('v-title').innerText = title;

            try {
                const csvUrl = url.includes("google.com") ? url.replace(/\/edit.*$/, '/export?format=csv') : url;
                const res = await fetch(csvUrl);
                const text = await res.text();
                window.rawData = text.split('\n').filter(l => l.trim()).map(l => l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim()));

                if(typeof window.populateFilters === "function") {
                    window.populateFilters();
                    window.recomputeViz();
                } else {
                    setTimeout(() => { window.populateFilters(); window.recomputeViz(); }, 800);
                }
            } catch (err) { alert("Error: " + err.message); closeViz(); }
        }

        function setTab(t) { tab = t; document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); document.getElementById('n-'+t).classList.add('active'); drawTable(); }
        function resetFilters() { document.getElementById('ent-search').value = ""; document.getElementById('orig-filter').value = "All"; document.getElementById('dest-filter').value = "All"; window.recomputeViz(); }
        function closeViz() { document.getElementById('viz-header-ui').style.display = 'none'; document.getElementById('viz-container').style.display = 'none'; document.getElementById('list-header').style.display = 'flex'; document.getElementById('list-view').style.display = 'block'; if(LMap) { LMap.remove(); LMap = null; } }
        function openMod() { document.getElementById('add-modal').style.display = 'flex'; }
        function closeMod() { document.getElementById('add-modal').style.display = 'none'; }
        function openClientMod() { document.getElementById('client-modal').style.display = 'flex'; }
        function closeClientMod() { document.getElementById('client-modal').style.display = 'none'; }
    </script>
</body>
</html>
