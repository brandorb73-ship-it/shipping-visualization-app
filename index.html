<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrandOrb Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-curve@1.0.0/leaflet.curve.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --navy: #0f172a; --blue: #38bdf8; --bg: #f8fafc; --white: #ffffff; }
        body { margin: 0; font-family: 'Inter', sans-serif; display: flex; height: 100vh; background: var(--bg); overflow: hidden; }

        /* Sidebar & Logo Tile */
        #sidebar { width: 260px; background: var(--navy); display: flex; flex-direction: column; color: white; }
        .logo-container { padding: 20px; display: flex; justify-content: center; }
        .logo-tile { 
            width: 100%; height: 80px; background: white; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; padding: 10px;
        }
        .logo-tile img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .nav-item { padding: 15px 25px; cursor: pointer; color: #94a3b8; font-weight: 700; font-size: 12px; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .nav-item.active { background: rgba(56, 189, 248, 0.1); color: var(--blue); border-right: 4px solid var(--blue); }

        /* Main Content */
        #main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 20px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        
        #viz-container { flex-grow: 1; position: relative; background: #fff; }
        #map-frame { width: 100%; height: 100%; }

        /* Controls */
        .controls { padding: 10px 20px; background: #f1f5f9; display: flex; gap: 10px; border-bottom: 1px solid #e2e8f0; }
        select, input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 12px; }

        /* Popup Styling */
        .map-popup-container { max-width: 420px; font-size: 12px; }
        .popup-scroll { max-height: 180px; overflow-y: auto; margin-top: 10px; border: 1px solid #eee; }
        .popup-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .popup-table th { background: #f8fafc; padding: 8px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #e2e8f0; }
        .popup-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; }

        .btn-p { background: var(--blue); color: var(--navy); border: none; padding: 8px 15px; border-radius: 6px; font-weight: 700; cursor: pointer; }
        .delete-btn { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
        
        #loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
    </style>
</head>
<body>

<aside id="sidebar">
    <div class="logo-container">
        <div class="logo-tile" id="sidebar-logo">
            <span style="color:var(--navy); font-weight:900; font-size:20px;">BrandOrb</span>
        </div>
    </div>
    <div class="nav-item active" id="n-MAP" onclick="setTab('MAP')"><i class="fas fa-route"></i> ROUTE MAPS</div>
    <div class="nav-item" id="n-CLUSTER" onclick="setTab('CLUSTER')"><i class="fas fa-project-diagram"></i> CLUSTER GRAPHS</div>
    
    <div style="margin-top:auto; padding:20px; border-top:1px solid rgba(255,255,255,0.1);">
        <button class="btn-p" style="width:100%" onclick="showAddModal()">+ Add Report</button>
    </div>
</aside>

<div id="main">
    <header>
        <h2 id="viz-title" style="margin:0; font-size:18px;">Select a Report</h2>
        <div id="report-list-container" style="display:none; position:fixed; top:70px; right:20px; background:white; padding:20px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); z-index:2000; width:400px;">
            <table style="width:100%; border-collapse: collapse;">
                <thead><tr style="text-align:left; font-size:12px;"><th>Name</th><th>Client</th><th>Action</th></tr></thead>
                <tbody id="rep-rows"></tbody>
            </table>
            <button onclick="document.getElementById('report-list-container').style.display='none'" style="margin-top:10px; width:100%;">Close</button>
        </div>
        <button class="btn-p" onclick="toggleReportList()">Manage Reports</button>
    </header>

    <div class="controls">
        <input type="text" id="ent-search" placeholder="Search Entity/Product..." oninput="recomputeViz()">
        <select id="orig-filter" onchange="recomputeViz()"><option>All Origins</option></select>
        <select id="dest-filter" onchange="recomputeViz()"><option>All Destinations</option></select>
    </div>

    <div id="viz-container">
        <div id="loader"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
        <div id="map-frame"></div>
    </div>
</div>

<script>
    let reports = JSON.parse(localStorage.getItem('bo_reports')) || [];
    let currentTab = 'MAP';
    let rawData = null;
    let LMap = null;
    let clusterMode = 'COUNTRY';

    function setTab(t) {
        currentTab = t;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('n-' + t).classList.add('active');
        recomputeViz();
        drawTable();
    }

    function toggleReportList() {
        const el = document.getElementById('report-list-container');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
        drawTable();
    }

    function showAddModal() {
        const name = prompt("Report Name:");
        const client = prompt("Client Name:");
        const url = prompt("Google Sheets CSV URL:");
        if (name && url) {
            reports.push({ id: Date.now(), name, client, url, type: currentTab });
            localStorage.setItem('bo_reports', JSON.stringify(reports));
            drawTable();
        }
    }

    function deleteReport(id) {
        reports = reports.filter(r => r.id !== id);
        localStorage.setItem('bo_reports', JSON.stringify(reports));
        drawTable();
    }

    function drawTable() {
        document.getElementById('rep-rows').innerHTML = reports.filter(r => r.type === currentTab).map(r => `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:10px;">${r.name}</td>
                <td>${r.client}</td>
                <td>
                    <button class="btn-p" onclick="initViz('${r.url}', '${r.name}')">View</button>
                    <button class="delete-btn" onclick="deleteReport(${r.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`).join('');
    }

    // FUZZY DATA LOADER
    function getIdx(headers, targets) {
        const clean = headers.map(h => String(h).replace(/[^\x20-\x7E]/g, "").trim().toLowerCase());
        for (let t of targets) {
            const found = clean.indexOf(t.toLowerCase());
            if (found !== -1) return found;
        }
        return -1;
    }

    window.initViz = function(url, name) {
        document.getElementById('viz-title').innerText = name;
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('report-list-container').style.display = 'none';

        Papa.parse(url, {
            download: true,
            header: false,
            skipEmptyLines: true,
            complete: function(results) {
                document.getElementById('loader').style.display = 'none';
                if (results.data && results.data.length > 1) {
                    rawData = results.data;
                    populateFilters();
                    recomputeViz();
                }
            }
        });
    }

    function populateFilters() {
        const h = rawData[0];
        const data = rawData.slice(1);
        const fill = (id, target) => {
            const i = getIdx(h, [target]);
            if (i === -1) return;
            const vals = [...new Set(data.map(r => r[i]))].filter(v => v).sort();
            document.getElementById(id).innerHTML = `<option value="All">All ${target}</option>` + 
                vals.map(v => `<option value="${v}">${v}</option>`).join('');
        };
        fill('orig-filter', 'Origin Country');
        fill('dest-filter', 'Destination Country');
    }

    function recomputeViz() {
        if (!rawData) return;
        const h = rawData[0];
        const search = document.getElementById('ent-search').value.toLowerCase();
        const origF = document.getElementById('orig-filter').value;
        const destF = document.getElementById('dest-filter').value;

        const idx = {
            exp: getIdx(h, ["Exporter"]), imp: getIdx(h, ["Importer"]),
            oC: getIdx(h, ["Origin Country"]), dC: getIdx(h, ["Destination Country"]),
            lat1: getIdx(h, ["Origin latitude"]), lon1: getIdx(h, ["Origin longitude"]),
            lat2: getIdx(h, ["Destination latitude"]), lon2: getIdx(h, ["Destination longitude"]),
            prod: getIdx(h, ["PRODUCT"]), date: getIdx(h, ["Date"]), 
            qty: getIdx(h, ["Quantity"]), val: getIdx(h, ["Value(USD)"]),
            mode: getIdx(h, ["Mode of Transport"]), oPort: getIdx(h, ["Origin Port"]), dPort: getIdx(h, ["Destination Port"])
        };

        const rows = rawData.slice(1).filter(r => {
            if (!r[idx.exp]) return false;
            const oMatch = origF === 'All' || r[idx.oC] === origF;
            const dMatch = destF === 'All' || r[idx.dC] === destF;
            const sMatch = (r[idx.exp] + (r[idx.imp]||"") + (r[idx.prod]||"")).toLowerCase().includes(search);
            return oMatch && dMatch && sMatch;
        });

        const frame = document.getElementById('map-frame');
        frame.innerHTML = "";
        if (LMap) { LMap.remove(); LMap = null; }

        if (currentTab === 'MAP') {
            LMap = L.map('map-frame').setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(LMap);
            
            const groups = {};
            rows.forEach(r => {
                const key = `${r[idx.exp]}|${r[idx.imp]}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(r);
            });

            Object.values(groups).forEach(g => {
                const f = g[0];
                const p1 = [parseFloat(f[idx.lat1]), parseFloat(f[idx.lon1])];
                const p2 = [parseFloat(f[idx.lat2]), parseFloat(f[idx.lon2])];
                if (!isNaN(p1[0]) && !isNaN(p2[0])) {
                    L.polyline.antPath([p1, p2], { color: '#38bdf8', weight: 3 }).addTo(LMap)
                    .bindPopup(`
                        <div class="map-popup-container">
                            <b>Exporter:</b> ${f[idx.exp]} (${f[idx.oC]})<br>
                            <b>Importer:</b> ${f[idx.imp]} (${f[idx.dC]})<br>
                            <b>Ports:</b> ${f[idx.oPort] || 'N/A'} â†’ ${f[idx.dPort] || 'N/A'}
                            <div class="popup-scroll">
                                <table class="popup-table">
                                    <thead><tr><th>Date</th><th>Quantity</th><th>Value (USD)</th><th>PRODUCT</th><th>Mode</th></tr></thead>
                                    <tbody>${g.map(s => `<tr><td>${s[idx.date]}</td><td>${s[idx.qty]}</td><td>$${s[idx.val]}</td><td>${s[idx.prod]}</td><td>${s[idx.mode]}</td></tr>`).join('')}</tbody>
                                </table>
                            </div>
                        </div>`, { maxWidth: 450 });
                }
            });
        } else {
            drawClusterGraph(rows, idx);
        }
    }

    function drawClusterGraph(data, idx) {
        const frame = document.getElementById('map-frame');
        const width = frame.clientWidth, height = frame.clientHeight;
        const svg = d3.select("#map-frame").append("svg").attr("width", width).attr("height", height);
        const g = svg.append("g");
        svg.call(d3.zoom().on("zoom", (e) => g.attr("transform", e.transform)));

        let nodes = [], links = [], nodeSet = new Set();
        data.forEach(r => {
            const exp = r[idx.exp], imp = r[idx.imp];
            const p1 = r[idx.oC], p2 = r[idx.dC];
            [p1, p2, exp, imp].forEach((id, i) => {
                if(id && !nodeSet.has(id)) { nodes.push({id, type: i<2?'parent':(i===2?'exp':'imp')}); nodeSet.add(id); }
            });
            links.push({source: exp, target: imp, type: 'trade', data: r});
            links.push({source: p1, target: exp, type: 'link'});
            links.push({source: p2, target: imp, type: 'link'});
        });

        const sim = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width/2, height/2));

        const link = g.append("g").selectAll("line").data(links).enter().append("line")
            .attr("stroke", d => d.type === 'link' ? "#e2e8f0" : "#94a3b8").attr("stroke-width", 2);

        const node = g.append("g").selectAll("g").data(nodes).enter().append("g")
            .call(d3.drag().on("start", (e,d)=>{if(!e.active)sim.alphaTarget(0.3).restart();d.fx=d.x;d.fy=d.y})
            .on("drag",(e,d)=>{d.fx=e.x;d.fy=e.y}).on("end",(e,d)=>{if(!e.active)sim.alphaTarget(0);d.fx=null;d.fy=null}));

        node.append("circle").attr("r", d => d.type === 'parent' ? 22 : 16)
            .attr("fill", d => d.type === 'parent' ? '#1e293b' : (d.type === 'exp' ? '#0ea5e9' : '#f43f5e')).attr("stroke", "#fff");

        node.append("text").text(d => d.id).attr("y", 35).attr("text-anchor", "middle").style("font-size", "10px").style("font-weight", "bold");

        sim.on("tick", () => {
            link.attr("x1", d=>d.source.x).attr("y1", d=>d.source.y).attr("x2", d=>d.target.x).attr("y2", d=>d.target.y);
            node.attr("transform", d=>`translate(${d.x},${d.y})`);
        });
    }

    // Init
    drawTable();
</script>
</body>
</html>
