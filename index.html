<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrandOrb | Intelligence Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navy: #0f172a; --blue: #38bdf8; --grey: #64748b; --bg: #f8fafc; --border: #e2e8f0; --white: #ffffff; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100vw; font-family: 'Inter', sans-serif; background: var(--navy); overflow: hidden; }
        #app-container { width: 100vw; height: 100vh; background: var(--bg); display: flex; }
        #sidebar { width: 260px; background: var(--navy); color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; width: calc(100vw - 260px); }
        header { background: white; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); z-index: 10; }
        .header-actions { display: flex; gap: 8px; align-items: center; }
        .nav-item { 
    padding: 15px 25px; 
    cursor: pointer; 
    color: #94a3b8; 
    font-weight: 700; 
    font-size: 11px; 
    display: flex; 
    align-items: center; 
    gap: 10px; 
}

/* Red Delete Button Styling */
.delete-btn {
    background: #fee2e2;
    color: #ef4444;
    border: 1px solid #fecaca;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}
.delete-btn:hover { background: #ef4444; color: white; }
        .nav-item.active { color: var(--blue); background: rgba(56, 189, 248, 0.1); border-left: 4px solid var(--blue); }
        .btn-p { background: var(--navy); color: var(--blue); border: 1px solid var(--blue); padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: flex; align-items: center; gap: 6px; }
        .input-s { padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; outline: none; }
        .card { margin: 20px; background: white; border-radius: 8px; border: 1px solid var(--border); overflow: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 12px; text-align: left; font-size: 11px; color: var(--grey); border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 12px; }
        #viz-container { display: none; flex-direction: column; height: 100%; width: 100%; }
        #map-frame { flex-grow: 1; background: #f1f5f9; position: relative; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .popup-table { width: 100%; font-size: 10px; border-collapse: collapse; margin-top: 10px; }
        .popup-table th, .popup-table td { border: 1px solid #ddd; padding: 4px; text-align: left; }
        
        /* New Cluster Pop-up Style */
        .cluster-pop { 
    position: absolute; 
    background: white; 
    padding: 15px; 
    border-radius: 8px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
    z-index: 2000; 
    font-size: 12px;
    border: 1px solid #e2e8f0;
}
.pop-close {
    position: absolute;
    top: 5px;
    right: 8px;
    cursor: pointer;
    font-weight: bold;
    color: #64748b;
} 
<style>
    /* THE LOGO TILE - RIGID CONTAINER */
    .logo-container {
        width: 100%;
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        justify-content: center;
        background: #0f172a; /* Matches sidebar */
    }

    .logo-tile { 
        width: 180px; 
        height: 80px; 
        background: #FFFFFF !important; /* The light color container */
        display: flex; 
        align-items: center; 
        justify-content: center;
        border-radius: 12px;
        padding: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        overflow: hidden;
    }

    .logo-tile img { 
        max-width: 100%; 
        max-height: 100%; 
        object-fit: contain; /* Keeps logo from stretching */
    }

    /* PREVENT OVERLAP */
    #sidebar { 
        width: 260px; 
        background: #0f172a; 
        display: flex; 
        flex-direction: column; 
        height: 100vh;
    }
    
    .nav-container {
        flex-grow: 1;
        margin-top: 10px;
    }
</style>

        
    /* Toggle Switches for Cluster */
    .viz-controls {
        padding: 10px 20px;
        display: flex;
        gap: 10px;
        background: #f1f5f9;
        border-bottom: 1px solid #e2e8f0;
    }
    .toggle-btn {
        padding: 6px 12px;
        font-size: 11px;
        font-weight: 700;
        border-radius: 20px;
        border: 1px solid #cbd5e1;
        background: white;
        cursor: pointer;
    }
    .toggle-btn.active {
        background: #0f172a;
        color: white;
        border-color: #0f172a;
    }
</style>
}

.logo-slot img { 
    max-width: 85%; 
    max-height: 70px; 
    object-fit: contain;
    filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.2));
}

    .map-popup-container {
    max-width: 420px;
    font-family: sans-serif;
}
.popup-scroll {
    max-height: 180px; 
    overflow-y: auto;
    margin-top: 10px;
    border: 1px solid #eee;
}
.popup-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 10px;
}
.popup-table th { background: #f4f4f4; padding: 5px; text-align: left; position: sticky; top: 0; }
.popup-table td { padding: 5px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div id="login-scr" style="position:fixed; inset:0; background:var(--navy); display:flex; align-items:center; justify-content:center; z-index:9999;">
        <div style="background:white; padding:40px; border-radius:12px; width:300px; text-align:center;">
            <div id="login-logo-preview" style="margin-bottom: 20px;"><h2>BrandOrb</h2></div>
            <input type="password" id="pass" class="input-s" placeholder="Access Key" style="width:100%; margin-bottom:15px;">
            <div style="font-size: 10px; color: gray; margin-bottom: 5px; text-align: left;">Upload Logo (Optional):</div>
            <input type="file" id="logo-upload" class="input-s" style="width:100%; margin-bottom:15px; font-size: 10px;" accept="image/*">
            <button class="btn-p" onclick="doLogin()" style="width:100%; justify-content:center;">Enter Dashboard</button>
        </div>
    </div>

    <div id="app-container">
       <aside id="sidebar">
    <div class="logo-container">
        <div class="logo-tile" id="sidebar-logo">
            <span style="font-weight:900; color:#0f172a; font-size:1.2rem;">BrandOrb</span>
        </div>
    </div>
    <div class="nav-container">
        <div class="nav-item active" id="n-MAP" onclick="setTab('MAP')"><i class="fas fa-route"></i> ROUTE MAPS</div>
        <div class="nav-item" id="n-CLUSTER" onclick="setTab('CLUSTER')"><i class="fas fa-project-diagram"></i> CLUSTER GRAPHS</div>
    </div>
</aside>

        <main id="main-content">
            <header id="list-header">
                <h1>Intelligence Reports</h1>
                <div class="header-actions">
                    <button class="btn-p" onclick="openClientMod()"><i class="fas fa-user-plus"></i> Add Client</button>
                    <button class="btn-p" onclick="openMod()"><i class="fas fa-plus"></i> Add Report</button>
                    <button class="btn-p" onclick="changePass()"><i class="fas fa-key"></i> Change Key</button>
                </div>
            </header>

            <header id="viz-header-ui" style="display:none">
                <button class="btn-p" onclick="backToDashboard()"><i class="fas fa-arrow-left"></i> Back</button>
                <div class="header-actions">
                    <input type="text" id="ent-search" class="input-s" placeholder="Search Entity/Product..." onkeyup="window.recomputeViz()">
                    <select id="orig-filter" class="input-s" onchange="window.recomputeViz()"></select>
                    <select id="dest-filter" class="input-s" onchange="window.recomputeViz()"></select>
                    <button class="btn-p" onclick="window.downloadPDF()"><i class="fas fa-file-pdf"></i> Download PNG</button>
                </div>
            </header>

            <div id="list-view" class="card">
                <table>
                    <thead><tr><th>Name</th><th>Client</th><th>Type</th><th>Action</th></tr></thead>
                    <tbody id="rep-rows"></tbody>
                </table>
            </div>
            <div id="viz-container"><div id="map-frame"></div></div>
        </main>
    </div>

    <div id="add-modal" class="modal">
        <div style="background:white; padding:30px; border-radius:8px; width:400px;">
            <h3>New Report</h3>
            <input type="text" id="m-title" class="input-s" placeholder="Title" style="width:100%; margin-bottom:10px;">
            <input type="text" id="m-url" class="input-s" placeholder="CSV URL" style="width:100%; margin-bottom:10px;">
            <select id="m-client" class="input-s" style="width:100%; margin-bottom:10px;"></select>
            <select id="m-type" class="input-s" style="width:100%; margin-bottom:20px;">
                <option value="MAP">Route Map</option>
                <option value="CLUSTER">Cluster Graph</option>
            </select>
            <button class="btn-p" onclick="publishReport()" style="width:100%; justify-content:center;">Publish</button>
            <button class="btn-p" onclick="document.getElementById('add-modal').style.display='none'" style="width:100%; justify-content:center; margin-top:5px; background:none; border:none; color:gray;">Cancel</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/elfalem/Leaflet.curve@master/src/leaflet.curve.js"></script>
    <script src="https://unpkg.com/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="visuals.js"></script>

    <script>
        let currentKey = localStorage.getItem('bo_key') || "admin123";
        let reports = JSON.parse(localStorage.getItem('bo_reports')) || [];
        let clients = JSON.parse(localStorage.getItem('bo_clients')) || ["General"];
        window.currentTab = 'MAP';

        // Fix: Logo handling
        let uploadedLogo = null;
        document.getElementById('logo-upload').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function() {
                uploadedLogo = reader.result;
                document.getElementById('login-logo-preview').innerHTML = `<img src="${uploadedLogo}" style="max-width:150px; max-height:60px;">`;
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        function doLogin() {
            if(document.getElementById('pass').value === currentKey) {
                document.getElementById('login-scr').style.display = 'none';
                if(uploadedLogo) {
                    document.getElementById('sidebar-logo').innerHTML = `<img src="${uploadedLogo}">`;
                }
                updateClientMenu(); drawTable();
            } else alert("Invalid Key");
        }

        // Fix: Back Button Logic (prevents reload/logout)
        function backToDashboard() {
            document.getElementById('viz-header-ui').style.display = 'none';
            document.getElementById('viz-container').style.display = 'none';
            document.getElementById('list-header').style.display = 'flex';
            document.getElementById('list-view').style.display = 'block';
            // Cleanup any cluster popups left behind
            d3.selectAll('.cluster-pop').remove();
        }

        function setTab(t) { 
            window.currentTab = t; 
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); 
            document.getElementById('n-'+t).classList.add('active'); 
            drawTable(); 
        }

        // Rest of functions (updateClientMenu, drawTable, etc.) are standard
        function changePass() {
            const nw = prompt("Enter New Access Key:");
            if(nw) { currentKey = nw; localStorage.setItem('bo_key', nw); alert("Key Updated"); }
        }
        function openClientMod() {
            const c = prompt("Enter Client Name:");
            if(c) { clients.push(c); localStorage.setItem('bo_clients', JSON.stringify(clients)); updateClientMenu(); }
        }
        function updateClientMenu() {
            document.getElementById('m-client').innerHTML = clients.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        function publishReport() {
            const r = { id: Date.now(), name: document.getElementById('m-title').value, url: document.getElementById('m-url').value, type: document.getElementById('m-type').value, client: document.getElementById('m-client').value };
            reports.push(r); localStorage.setItem('bo_reports', JSON.stringify(reports)); drawTable(); document.getElementById('add-modal').style.display='none';
        }
    // Function to render the list of reports
function drawTable() {
    const tableBody = document.getElementById('rep-rows');
    const filtered = reports.filter(r => r.type === window.currentTab);
    
    if (filtered.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px;">No reports added yet.</td></tr>`;
        return;
    }

    tableBody.innerHTML = filtered.map(r => `
        <tr>
            <td>${r.name}</td>
            <td>${r.client}</td>
            <td>${r.type}</td>
            <td>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-p" onclick="window.initViz('${r.url}', '${r.name}')">View</button>
                    <button class="delete-btn" onclick="deleteReport(${r.id})"><i class="fas fa-trash-alt"></i></button>
                </div>
            </td>
        </tr>`).join('');
}

// Function to handle report deletion
function deleteReport(id) {
    if (confirm("Are you sure you want to delete this report?")) {
        // Remove from the array
        reports = reports.filter(report => report.id !== id);
        // Save back to local storage
        localStorage.setItem('bo_reports', JSON.stringify(reports));
        // Refresh the table
        drawTable();
    }
}
// Global function to initialize visualization
window.initViz = function(url, name) {
    console.log("Attempting to load:", name, "URL:", url);
    
    // 1. Update Title and Show Loader
    document.getElementById('viz-title').innerText = name;
    document.getElementById('loader').style.display = 'flex';
    
    // 2. Clear previous map state
    const frame = document.getElementById('map-frame');
    frame.innerHTML = "";

    // 3. Fetch and Parse CSV
    Papa.parse(url, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
            console.log("CSV Parse Complete. Rows found:", results.data.length);
            document.getElementById('loader').style.display = 'none';
            
            if (results.data && results.data.length > 1) {
                window.rawData = results.data;
                // These functions live in visuals.js
                if (typeof window.populateFilters === "function") window.populateFilters();
                if (typeof window.recomputeViz === "function") window.recomputeViz();
            } else {
                alert("The CSV file appears to be empty or formatted incorrectly.");
            }
        },
        error: function(err) {
            document.getElementById('loader').style.display = 'none';
            console.error("PapaParse Error:", err);
            alert("Could not load CSV. Ensure the link is a 'Public' Google Sheets CSV link.");
        }
    });
};
        function openMod() { document.getElementById('add-modal').style.display = 'flex'; }
    </script>
</body>
</html>
